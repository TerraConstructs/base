// https://github.com/aws/aws-cdk/blob/dd912daf2b91a4a32064341e92863afbd9eeebdd/packages/aws-cdk-lib/aws-iam/lib/group.ts

import { Construct } from "constructs";
import { IamGroup as TerraformIamGroup } from "@cdktf/provider-aws";
import { Lazy } from "cdktf";
import {
  AwsConstructBase,
  AwsConstructProps,
  IAwsConstruct,
} from "../aws-construct";
import { AwsStack } from "../aws-stack";
import { ArnFormat } from "../arn";
import { Annotations, Lazy as CoreLazy, Stack } from "../../core";
import { IIdentity } from "./identity-base";
import { IManagedPolicy } from "./managed-policy";
import { Policy } from "./policy";
import { PolicyStatement } from "./policy-statement";
import {
  AddToPrincipalPolicyResult,
  ArnPrincipal,
  IPrincipal,
  PrincipalPolicyFragment,
} from "./principals";
import { AttachedPolicies } from "./private/util";
import { IUser } from "./user";

/**
 * Represents an IAM Group.
 *
 * @see https://docs.aws.amazon.com/IAM/latest/UserGuide/id_groups.html
 */
export interface IGroup extends IIdentity, IAwsConstruct {
  /**
   * Returns the IAM Group Name
   *
   * @attribute
   */
  readonly groupName: string;

  /**
   * Returns the IAM Group ARN
   *
   * @attribute
   */
  readonly groupArn: string;
}

/**
 * Properties for defining an IAM group.
 */
export interface GroupProps extends AwsConstructProps {
  /**
   * A name for the IAM group. For valid values, see the GroupName parameter
   * for the CreateGroup action in the IAM API Reference. If you don't specify
   * a name, a unique physical name will be generated.
   *
   * @default Generated by the framework (recommended)
   */
  readonly groupName?: string;

  /**
   * A list of managed policies to associate with this group.
   *
   * You can later add managed policies by calling addManagedPolicy.
   *
   * @default - No managed policies.
   */
  readonly managedPolicies?: IManagedPolicy[];

  /**
   * The path to the group. For more information about paths, see
   * "IAM Identifiers" in the IAM User Guide.
   *
   * @default "/"
   */
  readonly path?: string;
}

/**
 * Base class for IAM Groups.
 */
abstract class GroupBase extends AwsConstructBase implements IGroup {
  public abstract readonly groupName: string;
  public abstract readonly groupArn: string;

  public readonly grantPrincipal: IPrincipal = this;
  public readonly principalAccount: string | undefined = this.env.account;
  public readonly assumeRoleAction: string = "sts:AssumeRole";

  private readonly attachedPolicies = new AttachedPolicies();
  private defaultPolicy?: Policy;

  public get policyFragment(): PrincipalPolicyFragment {
    return new ArnPrincipal(this.groupArn).policyFragment;
  }

  /**
   * Attaches an inline policy to this group.
   * @param policy The policy to attach.
   */
  public attachInlinePolicy(policy: Policy): void {
    this.attachedPolicies.attach(policy);
    policy.attachToGroup(this);
  }

  /**
   * Adds a managed policy to this group.
   * (Note: In TerraConstructs managed policies are attached separately so this method just tracks them.)
   */
  public addManagedPolicy(_policy: IManagedPolicy): void {
    // No-op here; managed policies are attached externally via separate resources.
  }

  /**
   * Adds a user to this group.
   */
  public addUser(user: IUser): void {
    user.addToGroup(this);
  }

  /**
   * Adds an IAM statement to the default policy.
   */
  public addToPrincipalPolicy(
    statement: PolicyStatement,
  ): AddToPrincipalPolicyResult {
    if (!this.defaultPolicy) {
      this.defaultPolicy = new Policy(this, "DefaultPolicy");
      this.defaultPolicy.attachToGroup(this);
    }
    this.defaultPolicy.addStatements(statement);
    return { statementAdded: true, policyDependable: this.defaultPolicy };
  }

  public addToPolicy(statement: PolicyStatement): boolean {
    return this.addToPrincipalPolicy(statement).statementAdded;
  }
}

/**
 * An IAM Group (a collection of IAM users) which lets you specify permissions for multiple users.
 *
 * @see https://docs.aws.amazon.com/IAM/latest/UserGuide/id_groups.html
 */
export class Group extends GroupBase {
  /**
   * Import an external group by ARN.
   *
   * Note: If the imported Group ARN is a Token and contains a path,
   * the groupName property may not resolve correctly. In that case supply an ARN without a path.
   *
   * @param scope construct scope
   * @param id construct id
   * @param groupArn the ARN of the group to import (e.g. arn:aws:iam::account-id:group/group-name)
   */
  public static fromGroupArn(
    scope: Construct,
    id: string,
    groupArn: string,
  ): IGroup {
    const arnComponents = AwsStack.ofAwsConstruct(scope).splitArn(
      groupArn,
      ArnFormat.SLASH_RESOURCE_NAME,
    );
    const groupName = arnComponents.resourceName!;
    class Import extends GroupBase {
      public groupName = groupName;
      public groupArn = groupArn;
      public principalAccount = arnComponents.account;
    }
    return new Import(scope, id);
  }

  /**
   * Import an existing group by given name (including path).
   *
   * @param scope construct scope
   * @param id construct id
   * @param groupName the full group name (with path) of the existing group to import
   */
  public static fromGroupName(
    scope: Construct,
    id: string,
    groupName: string,
  ): IGroup {
    const groupArn = AwsStack.ofAwsConstruct(scope).formatArn({
      service: "iam",
      region: "",
      resource: "group",
      resourceName: groupName,
    });
    return Group.fromGroupArn(scope, id, groupArn);
  }

  public readonly groupName: string;
  public readonly groupArn: string;

  private readonly managedPolicies: IManagedPolicy[] = [];

  constructor(scope: Construct, id: string, props: GroupProps = {}) {
    super(scope, id, { physicalName: props.groupName });

    if (props.managedPolicies) {
      this.managedPolicies.push(...props.managedPolicies);
    }

    // Create the IAM Group using Terraform AWS Provider's IAM Group.
    const groupResource = new TerraformIamGroup(this, "Resource", {
      name: this.physicalName,
      path: props.path,
    });

    this.groupName = this.getResourceNameAttribute(groupResource.ref);
    this.groupArn = this.getResourceArnAttribute(groupResource.arn, {
      region: "", // IAM is global per partition.
      service: "iam",
      resource: "group",
      resourceName: `${props.path ? (props.path.startsWith("/") ? props.path.substring(1) : props.path) : ""}${this.physicalName}`,
    });

    this.managedPoliciesExceededWarning();
  }

  /**
   * Attaches a managed policy to this group.
   * @param policy The managed policy to attach.
   */
  public addManagedPolicy(policy: IManagedPolicy): void {
    if (this.managedPolicies.indexOf(policy) >= 0) {
      return;
    }
    this.managedPolicies.push(policy);
    this.managedPoliciesExceededWarning();
  }

  private managedPoliciesExceededWarning(): void {
    if (this.managedPolicies.length > 10) {
      Annotations.of(this).addWarningV2(
        "@aws-cdk/aws-iam:groupMaxPoliciesExceeded",
        `You added ${this.managedPolicies.length} managed policies to IAM Group ${this.physicalName}. The maximum number of managed policies attached to an IAM group is 10.`,
      );
    }
  }
}
